<!-- ===========================================ramy========================================================= -->
{% extends 'base.html' %}
{% block content %}
<script>
    function get_details(project_id) {
        location.assign(`projects/${project_id}`)
    }


    function addComment(event,project_id) {
        event.preventDefault()
        console.log(project_id)
        console.log($(`#comment${project_id}`).val())
        $.ajax({
            url:"",
            method:"POST",
            data:{"comment":$(`#comment${project_id}`).val(),"project_id":project_id,csrfmiddlewaretoken:$("input[name='csrfmiddlewaretoken']").val()},
            dataType:"json",
            success:function(result){
            newComment=$(`<div class="border m-3 border-primary row" style="display: none;">
                        <div class="col-4">
                            <img width="70px" height="70px" class="rounded-circle" src="{{user_pic_url}}" alt="">
                        <p class="text-success">{{request.user}}</p>
                        </div>
                        <div class="col-8">
                            <span>${$(`#comment${project_id}`).val()}</span>
                        </div>
                    </div>`)
            $(`#pills-Comments-${project_id}`).prepend(newComment)
            $(`#comment${project_id}`).val("")
            $(newComment).show(500)
            },
            error:function(error){console.log('no')}
            });
        }
        

        function addReport(event,project_id) {
        event.preventDefault()
        reports=$(event.target).val()
        $.ajax({
            url:"addreport",
            method:"POST",
            data:{"project_id":project_id,csrfmiddlewaretoken:$("input[name='csrfmiddlewaretoken']").val(),'body':$(`textarea[name='body${project_id}']`).val()},
            dataType:"json",
            success:function(result){ 
                $(`#form${project_id}`).html(`<button class="btn btn-danger number-reports" value=${parseInt(reports)+1} onclick="delReport(event , ${ project_id } )" >${parseInt(reports)+1} Total reports .. remove your report ? </button>`)
                alert(result.message)

            },
            error:function(error){
                console.log('not added')
                }
            });
        }

        function delReport(event,project_id) {
        reports=$(event.target).val()
        event.preventDefault()
        $.ajax({
            url:"delreport",
            method:"POST",
            data:{"project_id":project_id,csrfmiddlewaretoken:$("input[name='csrfmiddlewaretoken']").val()},
            dataType:"json",
            success:function(result){ 
                                $(`#form${project_id}`).html(`<textarea class="form-control" name="body${project_id}" placeholder="Write a comment ..." id="comment-{{project.id}}" rows="3"></textarea>
                                        <button type="submit" class="btn btn-success number-reports" value="${parseInt(reports)-1}" onclick="addReport(event,${ project_id })" >${parseInt(reports)-1} Total reports .. add a report ?</button>`)
                alert(result.message)
            },
            error:function(error){
                console.log('not added')
                }
            });
        }
    

</script>
<style>
 .stars_outer{
     position: relative;
     display: inline-block;
    }
 .stars_inner{
     position: absolute;
     top: 0;
     left: 0;
     white-space: nowrap;
     overflow: hidden;
    }
 .stars_outer::before{
     content:"\f005 \f005 \f005 \f005 \f005 ";
     font-family: 'Font Awesome 5 Free';
     font-weight: 900;
     color:grey;
 }
 .stars_inner::before{
     content:"\f005 \f005 \f005 \f005 \f005 ";
     font-family: 'Font Awesome 5 Free';
     font-weight: 900;
     color:goldenrod;
 }
</style>
<div class="container">
    <div class="row">
        <div class="m-auto">
            <div class="card-columns" >
                {% for project in all_projects %}
                <div class="card">
                <div class="text-right">
                    <!-- Button trigger modal -->
                    <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#report-{{project.id}}-Modal">
                        <i class="fas fa-flag"></i>
                    </button>
                    <!-- Modal -->
                    <div class="modal fade" id="report-{{project.id}}-Modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <form id='form{{project.id}}'>
                                        {% csrf_token %}
                                        {% if project.is_reported %}
                                        <button class="btn btn-danger number-reports" value={{project.project_reports}}  onclick="delReport(event , {{ project.id }} )" >{{project.project_reports}} Total reports .. remove your report ?</button>
                                        {% else %}
                                        <textarea class="form-control" name="body{{project.id}}" placeholder="Write a comment ..." id="comment-{{project.id}}" rows="3"></textarea>
                                        <button type="submit" class="btn btn-success number-reports" value={{project.project_reports}} onclick="addReport(event,{{project.id}})" >{{project.project_reports}} Total reports .. add a report ?</button>
                                        {% endif %}
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="img{{project.id}}" class="carousel slide w-100 card-img-top" data-ride="carousel">
                    <ol class="carousel-indicators">
                    {% with project.pics|length as num %}
                    {% for i in ''|center:num %}
                            {% if forloop.first %}
                                <li data-target="#img{{project.id}}" data-slide-to="{{forloop.counter0}}" class="active"></li>
                            {% else %}
                                <li data-target="#img{{project.id}}" data-slide-to="{{forloop.counter0}}"></li>
                            {% endif %}
                    {% endfor %}
                    {% endwith %}
                    </ol>
                    <div class="carousel-inner">
                        {% for pic in project.pics %}
                            {% if forloop.first %}
                                <div class="carousel-item active">
                                    <img class="d-block w-100" height="200px" src="{{pic}}" alt="{{project.id}}">
                                </div>
                            {% else %}
                                <div class="carousel-item">
                                    <img class="d-block w-100" height="200px" src="{{pic}}" alt="{{project.id}}">
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <a class="carousel-control-prev" href="#img{{project.id}}" role="button" data-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="sr-only">Previous</span>
                    </a>
                    <a class="carousel-control-next" href="#img{{project.id}}" role="button" data-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="sr-only">Next</span>
                    </a>
                </div>
                    <div class="rating text-right">
                        <div class="stars_outer " style="position: relative;display: inline-block;">
                            <div class="stars_inner" style="width: {{project.rate_percentage}}%;"></div>
                        </div>
                        <span class="number-rating">{{project.rate}}</span>
                    </div>
                <div class="card-body text-center ">
                    <img width="70px" height="70px" class="rounded-circle border  border-primary" src="{{ project.user_id.profile.profile_pic.url }}" alt="">
                    <h5 class="card-title  text-danger">{{project.title}}</h5>
                    <p class="card-text">{{project.details}}</p>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped bg-danger" role="progressbar" style="width:{{project.progress}}%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                    </div> 
                    <div class="card-footer">
                        <small>{{project.remaining}}</small>
                    </div>
                    <button class="btn btn-info rounded m-1" onClick="get_details({{project.id}})" ><span>Details</span></button>
                    <a class="btn btn-primary rounded m-1" data-toggle="collapse" href="#collapse{{project.id}}" role="button" aria-expanded="false" aria-controls="collapse{{project.id}}">
                        <span>Comments </span><i class="far fa-comment fa-1x"></i>
                    </a>
                    <div class="comments collapse" id="collapse{{project.id}}">
                        <div class="tab-content" id="pills-tabContent">
                            <div class="m-3">
                                <form class="comment-form " >
                                    {% csrf_token %}
                                    <div class="form-group">
                                        <textarea class="form-control" placeholder="Write a comment ..." id="comment{{project.id}}" rows="3"></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-warning m-3" onclick="addComment(event,{{project.id}})" >Comment</button>
                                </form>
                            </div>
                            <div class="tab-pane fade show active" id="pills-Comments-{{project.id}}" role="tabpanel" aria-labelledby="pills-comments-tab">
                                {% for comment in project.comments %}
                                <div class="border m-3 border-primary row">
                                    <div class="col-4">
                                    {% if comment.user.profile.profile_pic.url %}
                                        <img width="70px" height="70px" class="rounded-circle" src="{{comment.user.profile.profile_pic.url}}" alt="">
                                    {% else %}
                                        <img width="70px" height="70px" class="rounded-circle" src="static/images/profiles/default_profile.png" alt="">
                                    {% endif %}
                                    <p class="text-success">{{comment.user}}</p>
                                    </div>
                                    <div class="col-8">
                                        <span>{{comment.body}}</span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
<!-- ===========================================ramy========================================================= -->
